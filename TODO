-- bugs --
H	battering ram is not moving when assault target is set
	the destination is inside an obstacle and path_find fails
	// make assault command possible only when the troop is close enough to an obstacle
H	two horses blocked during battle (neither attacks an archer)
	// when they start moving, they collide again
M	if_init fails (in glXMakeContextCurrent) when used with ssh forwarding
M	fast units cannot always catch up with slow units even when they are close enough (seen with light cavalry and peasant)

http://stackoverflow.com/questions/6543924/is-double-buffering-needed-any-more#6544453

flickering
	https://groups.google.com/forum/#!topic/android-developers/om5Utez9PgA

#0  0x00007ffff692d0a7 in raise () from /lib64/libc.so.6
#1  0x00007ffff692e419 in abort () from /lib64/libc.so.6
#2  0x00007ffff69261c6 in __assert_fail_base () from /lib64/libc.so.6
#3  0x00007ffff6926272 in __assert_fail () from /lib64/libc.so.6
#4  0x00000000004115d6 in path_moves_tangent (pawn=0x6aa718, obstacle=0x6aa5e0, distance_covered=0.041666666666666664, moves=0x7ffffffee950) at pathfinding.c:787
#5  0x000000000040c6e7 in movement_collisions_resolve (game=0x7fffffffe100, battle=0x7ffffffeead0, graph=0x7ffffffee9d0, obstacles=0x7ffffffeea50) at movement.c:400
#6  0x00000000004035e0 in play_battle (game=0x7fffffffe100, region=0x6b3880, assault=0) at main.c:196
#7  0x00000000004040c4 in play (game=0x7fffffffe100) at main.c:399
#8  0x00000000004047ce in main (argc=1, argv=0x7fffffffe218) at main.c:522
(gdb) frame 4
#4  0x00000000004115d6 in path_moves_tangent (pawn=0x6aa718, obstacle=0x6aa5e0, distance_covered=0.041666666666666664, moves=0x7ffffffee950) at pathfinding.c:787
787		assert(moves_count <= 2);
(gdb) print moves_count
$3 = 4
(gdb) print origin
$8 = {x = 1.00006962, y = 0}
(gdb) print *obstacle
$9 = {troop = 0x6b3a20, count = 25, hurt = 0, position = {x = 5, y = 1}, position_next = {x = 5, y = 1}, path = {count = 0, capacity = 8, data = 0x6aa820}, moves = {count = 0, capacity = 8, data = 0x6aa7d0}, action = ACTION_DEFAULT, 
  target = {pawn = 0x1, position = {x = 1.40129846e-45, y = 0}, field = 0x1}, startup = 2}
(gdb) print *pawn
$10 = {troop = 0x690590, count = 25, hurt = 0, position = {x = 6.00006962, y = 1}, position_next = {x = 5.95840311, y = 1}, path = {count = 1, capacity = 8, data = 0x6aa910}, moves = {count = 1, capacity = 8, data = 0x6aa8c0}, 
  action = ACTION_DEFAULT, target = {pawn = 0x6b3628, position = {x = 9.84582569e-39, y = 0}, field = 0x6b3628}, startup = 2}
(gdb) print distance_covered
$11 = 0.041666666666666664
(gdb) print moves[0]
$12 = {x = 5.99961901, y = 1.04166424}
(gdb) print moves[1]
$13 = {x = 5.99961901, y = 0.958335757}
(gdb) print moves[2]
$14 = {x = 5.99961901, y = 1.04166424}
(gdb) print moves[3]
$15 = {x = 5.99961901, y = 0.958335757}
(gdb) print distance2
$16 = 1.0001392364501953
(gdb) print distance_tangent_point
$17 = 0.01179984958358845
(gdb) print minus_b
$18 = 0.98826894715692482
(gdb) print discriminant
$19 = 0

-- features --
H	AI improvements
	F computer map movement is weak
	computer map orders are weak
	computer cannot recover well from having negative food income
		// solution: dismiss troops
	////
	treating each troop separately when finding local maximum in AI will have bad results
	////
	in battle, AI is too slow when there are many pawns
	in battle, pawns move randomly when there are too many pawns
	when shooters attack a melee pawn and there is nowhere to run, the melee should attack back
	computer doesn't move the pawns during an assault
		// probably tries to attack unreachable pawns or the rating doesn't make the pawns approach the obstacles
	enemy should stay inside garrison when there are shooters
	shooters don't always shoot when they can
H	when only neutral and computer players remain, end game
H	error reporting on invalid map
	fix crash on invalid map (while freeing resources)
H	use a separate thread to calculate computer turns while the local player is choosing what to play
	add indicator (e.g. lighted bulb) for the players who have completed their turn
H	handle different screen resolutions better
H	region population
	income should be calculated as a function of the population
	one should be able to tell the population which resource to produce
	better food mechanics; food should not be accumulated indefinately
H	balance battles
	improve auto combat
	most of the pawn->count usually get killed at the same time (the round when the pawn dies)
H	when a region is invaded, garrison troops should have the option to fight
M	when a target is impossible, set target to the closest possible (e.g. if shooting range is not enough or a position is outside the battlefield)
M	region-specific features (income, population, units, buildings, battlefield)
	use BLOCKAGE_TERRAIN
	population growth
	army recruitment should reduce population
	population loyalty; revolts and civil wars
M	assault towers
M	catapult, balista
M	add ACTION_GUARD in battle
	the pawn is told an area which to guard; if an enemy goes into that area, the pawn sets ACTION_FIGHT on that enemy (this may happen in the middle between rounds)
M	map scrolling
M	network game (using SCTP?)
M	pawn morale
	low morale can make a pawn skip a round or retreat
M	water and ships
	shipyard - building producing transport ships; each ship has a fixed capacity (number of troop stacks) and a fixed speed (distance it sails in one turn)
	troops can set move destination to boarding the ship; at the same turn, the ship can start moving
	the ship can move freely in the water and can moor; if it moors, it cannot move after that the same turn; if the ship is set to moor, the troops will land in the corresponding region
	a moored ship is one that moored or was just produced at the shipyard; troops can board moored ships
	ships are displayed as a single ship on the map; when one clicks, one can see all the ships and the troops in each ship
	// troops on board of ships are stored in troop stacks - one troop stack for each ship
M	sound
M	improve AI (formation AI, predicting troops in unknown regions, etc.)
M	do something when there is not enough food for all troops (?kill some troops)
M	keyboard support in various places in the interface; mouse support in various places in the interface
M	improve world loading/saving
	support JSON comments
	support comma after last item
	log (level error) the line on which parse error occurs
	log (level error) when a compulsory field is not present or has the wrong type
	log (level warning) when an optional field has the wrong type; assume the field is not present for the execution logic
	refactor (simplify) the code using these ideas
M	? melee units should go closer to the shooter to prevent them from escaping far enough to shoot
M	make formation consistent with the new battle mechanics
L	better support for hotseat (choose player names; set game->hotseat to false when only 1 local player remains)
L	fast ships, big ships, battle ships; naval battles; ships participating in assault
L	battle: don't allow attacking if the attacker cannot do damage to the defender (due to weapon and armor type)
L	editor: position region neighbors properly
L	retreat can be abused for scouting (25 peasants can go and retreat for 1 food)
	maybe make retreat take some time (1 or 2 rounds); that way only fast units will be able to retreat
	maybe allow retreat only when the pawns are near the border of the battlefield?
	currently attackers retreating from an assault are killed; is this okay?
L	support splitting troops
L	limited number of shots
L	building destruction and repair
	buildings get damaged after an open battle; garrisons get damaged after an assault
L	armory, swordsman, crossbowman, heavy cavalry, horse archer
L	assault moat
L	roads
L	trade
L	religions, ethnicities, languages
L	dynamic alliances
L	seasons
L	? buildings should not generate income on the day they are built
L	? implement exit game while in battle
L	troops of dead players in allied regions remain alive
	they should either die, join the player or become neutral

? rename WEAPON_ARROW to WEAPON_PIERCING and change archer melee weapon to WEAPON_PIERCING

? dynamic battlefield size
? deal damage to each pawn escaping from enemy pawns

refactoring
	iterator for troops in a given stack (garrison / owned by player, dismissed, etc.)
	use 'struct point' only for drawing (draw.h) (fix point_eq calls)
		remove struct region dependency on struct point by moving center and location_garrison into location
	? rename image to sprite
	? change direction of everything to counterclockwise; currently the y axis is in the opposite direction (and the cross product is negated)
	? redesign input functions (handling mouse movement is tedious; handling writing should be unified; can I unify the two input functions?)
	? unify ACTION_FIGHT and ACTION_ASSAULT
	store region troops in stacks (like troops on ships); one special stack for garrison
	rename open battle to field battle (the same name can be applied at other places)
	revise user/computer battle input functions: combat_fight, combat_shoot, combat_assault, movement_queue; it should be clear what they do and how they interact

-- interface --

M	display a mirror image of enemy troops
	? display an ellipse with the owner below the troop (instead of changing some pixels in the sprite)
M	custom mouse pointer
M	improve player colors
M	flag patterns
M	show troops count, health, etc. only when alt is pressed
M	button input bottom and right coordinates should be exclusive (... - 1)

use stencil buffer when troops images don't fit into their rectangle (and will be on top of other images)
	https://open.gl/depthstencils

images
H	fortress*.png, fortress_gate*.png
H	assault indicator on the map

menu
H	startup image
M	no name editing after a world has been selected
L	directory tabs images

battle
H	display region name during battle
H	display calculated pawn moves (not a straight line)
H	when two pawns from different alliances are next to each other, display red line between them (to show that they are fighting)
H	fight animation (display which units are fighting)
H	display round number and number of rounds until retreat
H	new wall and gate images; open gate image
	display open gate when there is a pawn on top of the gate
H	tell all players if somebody is retreating
H	show gate strength even if there is a pawn on top of it
M	hide mouse pointer during animation
M	support showing more pawn stats (not just health)
M	change image for pawn selection
M	think about displaying reachable locations for a pawn
M	add battlefield animation indication when an enemy pawn makes a pawn stop (due to collision)
M	? movement and shoot animation is faster when its duration is shorter

report
H	in battle report, display which players retreated (maybe show white flag)
M	group players by alliances and show indicator for the alliance
M	? display minimap

map
H	improve boxes for field and garrison troops (it's not obvious one can place units there until there are units)
H	show income/expenses adjusted for troop movement (troops moved to garrison, attacking troops, etc.)
H	troop bar for just battering ram is not displayed on the map (because it's just 1 troop)
H	place the flag properly
M	troop movement animation
M	display current month and year
M	one should be able to tell all troops to go on assault
M	village image (will be displayed to the left of troops bar)
M	more tooltips
M	right clicking on a garrison on the map should be the same as clicking for assault
M	indicate on the map which region is selected (maybe with a border around it?)
M	show region-specific expenses
M	support showing troop stats
M	redesign arrows showing troop movement
